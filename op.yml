description: Runs a PostgeSQL database.
name: github.com/opspec-pkgs/postgresql.db.run
opspec: 0.1.6
version: 1.0.0
inputs:
  dbDataRootDir:
    dir:
      description: directory to put the database data folder.
  dbSchema:
    string:
      description: name of the database to be created.
      constraints: { minLength: 1 }
  dbUsername:
    string:
      description: username to connect to the database.
      constraints: { minLength: 1 }
  dbPassword:
    string:
      description: password to connect to the database.
      isSecret: true
      constraints: { minLength: 1 }
run:
  serial:
    - container:
        image: { ref: 'alpine:3.12' }
        dirs: { 
          '/dbDataRootDir': $(dbDataRootDir)
        }
        workDir: '/dbDataRootDir'
        envVars: { dbUsername }
        cmd:
          - sh
          - -ce
          - |
            if [ $dbUsername == "root" ]; then
              echo ERROR: dbUsername can\'t be root!
              exit 1
            fi
            if [ ! -d ./data ]; then
                mkdir ./data
            fi
            if [ ! -d ./data/postgresql-data ]; then
                mkdir ./data/postgresql-data
            fi
            exit 0
    - container:
        image: { ref: 'postgres:13.0-alpine' }
        name: postgresql-db
        dirs: { '/var/lib/postgresql/data': $(dbDataRootDir/data/postgresql-data) }
        envVars:
          POSTGRES_USER: $(dbUsername)
          POSTGRES_PASSWORD: $(dbPassword)
          POSTGRES_DB: $(dbSchema)
        ports: { '5432': '5432' }